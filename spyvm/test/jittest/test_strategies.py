import py

from .base import BaseJITTest

class TestBasic(BaseJITTest):

     # TODO: there shouldnt be allocations in this
     # The cond_call operations should also not show up...
    def test_range_asOrderedCollection(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000) asOrderedCollection.
        """)
        self.assert_matches(traces[0].loop, """
            i191 = getarrayitem_gc(p53, 1, descr=<ArrayS 4>)
            i192 = int_eq(i191, 2147483647)
            guard_false(i192, descr=<Guard0x37924d0>)
            i193 = int_ge(i191, i184)
            guard_true(i193, descr=<Guard0x37a1790>)
            cond_call(i75, 22145408, p67, descr=<Callv 0 r EF=2 OS=121>)
            cond_call(i101, 22145408, p90, descr=<Callv 0 r EF=2 OS=121>)
            cond_call(i101, 22145408, p90, descr=<Callv 0 r EF=2 OS=121>)
            p194 = getarrayitem_gc(p103, 0, descr=<ArrayP 4>)
            cond_call(i101, 22145408, p90, descr=<Callv 0 r EF=2 OS=121>)
            p196 = new_with_vtable(23559752)
            setfield_gc(p196, i184, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>)
            setarrayitem_gc(p103, 1, p196, descr=<ArrayP 4>)
            setarrayitem_gc(p79, 0, p194, descr=<ArrayP 4>)
            setfield_gc(p67, 2, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>)
            setfield_gc(p67, 11, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>)
            setfield_gc(p67, p0, descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>)
            setfield_gc(ConstPtr(ptr81), i87, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>)
            setarrayitem_gc(p79, 1, p196, descr=<ArrayP 4>)
            guard_class(p194, 23559528, descr=<Guard0x37a1710>)
            p198 = getfield_gc(p194, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_w_class 12>)
            p199 = getfield_gc(p198, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>)
            guard_value(p199, ConstPtr(ptr115), descr=<Guard0x37a1690>)
            guard_not_invalidated(descr=<Guard0x37a1610>)
            p200 = getfield_gc(p194, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>)
            setarrayitem_gc(p79, 0, ConstPtr(null), descr=<ArrayP 4>)
            setfield_gc(p67, 0, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>)
            setfield_gc(ConstPtr(ptr81), i130, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>)
            setarrayitem_gc(p79, 1, ConstPtr(null), descr=<ArrayP 4>)
            guard_class(p200, ConstClass(ListStorageShadow), descr=<Guard0x37a1590>)
            p203 = getfield_gc_pure(p200, descr=<FieldP spyvm.shadow.ListStorageShadow.inst_storage 16>)
            p204 = getarrayitem_gc(p203, 2, descr=<ArrayP 4>)
            p205 = getarrayitem_gc(p203, 0, descr=<ArrayP 4>)
            guard_class(p205, 23559528, descr=<Guard0x37a1510>)
            p206 = getfield_gc(p205, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_w_class 12>)
            p207 = getfield_gc(p206, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>)
            guard_value(p207, ConstPtr(ptr148), descr=<Guard0x37a1490>)
            p208 = getfield_gc(p205, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>)
            guard_nonnull_class(p208, 23564708, descr=<Guard0x37a1410>)
            p209 = getfield_gc_pure(p208, descr=<FieldP spyvm.shadow.SmallIntegerOrNilStorageShadow.inst_storage 16>)
            i210 = arraylen_gc(p209, descr=<ArrayS 4>)
            i211 = getfield_gc_pure(p208, descr=<FieldU spyvm.shadow.AbstractShadow.inst_space 12>)
            guard_nonnull_class(p204, 23559752, descr=<Guard0x37a1390>)
            i212 = getfield_gc_pure(p204, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>)
            i213 = int_eq(i212, i210)
            guard_false(i213, descr=<Guard0x37a1310>)
            i214 = int_add_ovf(i212, 1)
            guard_no_overflow(descr=<Guard0x37a1290>)
            i215 = int_ge(i212, 0)
            guard_true(i215, descr=<Guard0x37a1210>)
            i216 = int_lt(i212, i210)
            guard_true(i216, descr=<Guard0x37a1190>)
            i217 = int_eq(i184, 2147483647)
            guard_false(i217, descr=<Guard0x37a1110>)
            setarrayitem_gc(p209, i212, i184, descr=<ArrayS 4>)
            i218 = getarrayitem_gc(p53, 2, descr=<ArrayS 4>)
            setfield_gc(p67, -1, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>)
            setfield_gc(p67, ConstPtr(null), descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>)
            setfield_gc(ConstPtr(ptr81), i82, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>)
            i219 = int_eq(i218, 2147483647)
            guard_false(i219, descr=<Guard0x37a1090>)
            i220 = int_add_ovf(i184, i218)
            guard_no_overflow(descr=<Guard0x37a1010>)
            i221 = int_sub(i187, 4)
            setfield_gc(ConstPtr(ptr81), i221, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>)
            i222 = int_le(i221, 0)
            guard_false(i222, descr=<Guard0x3792f50>)
            p223 = new_with_vtable(23559752)
            setfield_gc(p223, i214, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>)
            setarrayitem_gc(p203, 2, p223, descr=<ArrayP 4>)
            i224 = arraylen_gc(p53, descr=<ArrayS 4>)
            i225 = arraylen_gc(p79, descr=<ArrayP 4>)
            i226 = arraylen_gc(p103, descr=<ArrayP 4>)
jump(p0, i1, p3, p6, i220, p14, p16, p18, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p53, i75, p67, i101, p90, p103, p79, i87, i89, i130, i82, i221, descr=TargetToken(58164944))
        """)
    
    def test_indexOf(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000000) asOrderedCollection indexOf: 9999999.
        """)
        # First loop: asOrderedCollection, second loop: makeRoomAtLast
        self.assert_matches(traces[2].loop, """
            i142 = int_le(i135, i62)
            guard_true(i142, descr=<Guard0x2ddf9d0>)
            guard_not_invalidated(descr=<Guard0x2ddf750>)
            setfield_gc(ConstPtr(ptr84), i90, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>)
            i143 = int_add_ovf(i135, i99)
            guard_no_overflow(descr=<Guard0x2ddf310>)
            i144 = int_sub(i143, 1)
            i145 = int_gt(i144, i107)
            guard_false(i145, descr=<Guard0x2ddf210>)
            i146 = int_sub(i144, 1)
            i147 = int_ge(i146, 0)
            guard_true(i147, descr=<Guard0x2dced10>)
            i148 = int_lt(i146, i125)
            guard_true(i148, descr=<Guard0x2dcec10>)
            i149 = getarrayitem_gc(p124, i146, descr=<ArrayS 4>)
            i150 = int_eq(i149, 2147483647)
            guard_false(i150, descr=<Guard0x2dceb50>)
            setfield_gc(ConstPtr(ptr84), i86, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>)
            i151 = int_eq(i149, i132)
            guard_false(i151, descr=<Guard0x2dce950>)
            i152 = int_add_ovf(i135, 1)
            guard_no_overflow(descr=<Guard0x2dce910>)
            i153 = int_sub(i138, 3)
            setfield_gc(ConstPtr(ptr84), i153, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>)
            i154 = int_le(i153, 0)
            guard_false(i154, descr=<Guard0x2dce8d0>)
            i155 = arraylen_gc(p95, descr=<ArrayP 4>)
            jump(p0, i1, p3, p6, p8, p10, i152, p14, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p44, p46, p48, p50, p52, i62, p64, i90, i99, p97, i107, p104, p110, i125, p124, i86, i132, i153, p95, descr=TargetToken(47907984))
        """)
